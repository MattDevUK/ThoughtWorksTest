{
  "variables": {
    "local_user": "matt",
    "remote_user": "ubuntu"
  },
  "builders": [{
    "type": "googlecompute",
    "account_file": "ThoughtWorks-820392232dfa.json",
    "project_id": "flash-span-180315",
    "source_image_family": "ubuntu-1604-lts",
    "zone": "europe-west1-b",
    "ssh_username": "{{user `remote_user`}}",
    "image_name": "thoughtworks-{{timestamp}}",
    "machine_type": "f1-micro"
  }],
  "provisioners": [{
    "type": "shell",
    "inline": [
      "sleep 30",
      "sudo apt-get update -y"
    ]
  },
  {
    "type": "file",
    "source": "/home/{{user `local_user`}}/ThoughtWorks/tw-repo",
    "destination": "/tmp/tw-repo"
  },
  {
    "type": "shell",
    "inline": [
      "sudo mv /tmp/tw-repo /home/{{user `remote_user`}}/",
      "sudo chown -R {{user `remote_user`}}:{{user `remote_user`}} /home/{{user `remote_user`}}/tw-repo/"
    ]
  },
  {
    "type": "chef-solo",
    "remote_cookbook_paths": ["/home/{{user `remote_user`}}/tw-repo/cookbooks"],
    "run_list": ["thoughtworks::default"]
  }]
}